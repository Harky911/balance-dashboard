<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <title>Balances Dashboard</title>
    <link rel="stylesheet" href="/node_modules/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="/node_modules/bootstrap-icons/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/styles.css" />
</head>

<body class="bg-dark text-light">
    <div class="container mt-5 mb-5">
        <section class="text-center mb-2 mt-2">
            <div class="row justify-content-center">
                <div class="col-md-12">
                    <div class="card ocean-nodes-section mb-2 shadow-sm">
                        <div class="card-body py-1">
                            <h5 class="text-white d-flex justify-content-center align-items-center mb-1">
                                For Users of
                                <img src="/images/logo_Nodes.svg" alt="Ocean Nodes" width="200" height="200" class="ms-2">
                            </h5>
                            <p class="small text-white mb-0">
                                This dashboard helps users track their balances on Ethereum and Fetch.ai when using
                                <a href="https://github.com/oceanprotocol/ocean-node" target="_blank" class="text-primary">
                                    Ocean Nodes
                                </a>.
                            </p>                            
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <section class="text-center mb-4">
            <div class="row justify-content-center">
                <div class="col-md-5">
                    <div class="card bg-light border mb-3 shadow-sm">
                        <div class="card-body py-3">
                            <h5 class="text-muted">Total ETH</h5>
                            <h2 id="total-eth" class="text-primary">Loading...</h2>
                            <p id="total-eth-usd" class="text-muted small">Loading...</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="card bg-light border mb-3 shadow-sm">
                        <div class="card-body py-3">
                            <h5 class="text-muted">Total FET</h5>
                            <h2 id="total-fet" class="text-success">Loading...</h2>
                            <p id="total-fet-usd" class="text-muted small">Loading...</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section class="mb-4">
            <div id="progress-container" class="progress mb-3">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-primary"
                    role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%
                </div>
            </div>
            <div id="complete-message" class="text-center text-muted" style="display: none;">
                <h6><i class="bi bi-check-circle"></i> All balances fetched successfully!</h6>
            </div>
        </section>

        <section class="mb-5">
            <div class="card h-100 border-0">
                <div class="card-body table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-borderless table-hover table-striped text-center align-middle sortable">
                        <thead class="table-light text-muted small">
                            <tr>
                                <th onclick="sortTable(0)"># <i class="bi bi-chevron-expand"></i></th>
                                <th onclick="sortTable(1)">Address <i class="bi bi-chevron-expand"></i></th>
                                <th onclick="sortTable(2)">ETH Balance <i class="bi bi-chevron-expand"></i></th>
                                <th>ETH (USD)</th>
                                <th onclick="sortTable(3)">FET Balance <i class="bi bi-chevron-expand"></i></th>
                                <th>FET (USD)</th>
                            </tr>
                        </thead>
                        <tbody id="balance-rows" class="small">
                            <tr>
                                <td colspan="6">Loading balances...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </div>

    <script>
        let indexCounter = 1;
        function fetchBalances() {
            const eventSource = new EventSource('/balance-updates');
            const balanceRows = document.getElementById('balance-rows');
            const progressBar = document.getElementById('progress-bar');
            const progressContainer = document.getElementById('progress-container');
            const completeMessage = document.getElementById('complete-message');

            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);

                const row = document.createElement('tr');
                row.innerHTML = `
            <td>${indexCounter++}</td>
            <td>
              ${data.address}
              <i class="bi bi-clipboard-fill text-muted mx-2" style="cursor: pointer;" title="Copy Address" onclick="copyToClipboard('${data.address}')"></i>
              <a href="https://etherscan.io/address/${data.address}" target="_blank" title="View on Etherscan">
                <i class="bi bi-box-arrow-up-right text-muted"></i>
              </a>
            </td>
            <td>${data.eth}</td>
            <td>$${data.ethUsd}</td>
            <td>${data.fet}</td>
            <td>$${data.fetUsd}</td>
          `;
                balanceRows.appendChild(row);

                document.getElementById('total-eth').textContent = data.totalEth;
                document.getElementById('total-fet').textContent = data.totalFet;
                document.getElementById('total-eth-usd').textContent = `$${data.totalEthUsd}`;
                document.getElementById('total-fet-usd').textContent = `$${data.totalFetUsd}`;

                progressBar.style.width = `${data.percentage}%`;
                progressBar.setAttribute('aria-valuenow', data.percentage);
                progressBar.textContent = `${data.percentage}%`;

                if (data.percentage === 100) {
                    progressBar.classList.remove('progress-bar-animated');
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        completeMessage.style.display = 'block';
                        completeMessage.style.color = '#ffffff';
                    }, 500);
                }

            };

            eventSource.addEventListener('end', () => {
                balanceRows.querySelector('tr:first-child').remove();
                eventSource.close();
            });
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Address copied to clipboard');
            });
        }

        function sortTable(columnIndex) {
            const table = document.querySelector('.sortable tbody');
            const rows = Array.from(table.rows);
            let isAscending = table.getAttribute('data-sort') === 'asc';

            rows.sort((rowA, rowB) => {
                const cellA = rowA.cells[columnIndex].innerText;
                const cellB = rowB.cells[columnIndex].innerText;

                const valueA = columnIndex > 0 ? parseFloat(cellA.replace(/[$,]/g, '')) : cellA;
                const valueB = columnIndex > 0 ? parseFloat(cellB.replace(/[$,]/g, '')) : cellB;

                return isAscending ? (valueA - valueB) : (valueB - valueA);
            });

            rows.forEach(row => table.appendChild(row));
            table.setAttribute('data-sort', isAscending ? 'desc' : 'asc');
        }

        window.onload = fetchBalances;
    </script>
</body>

</html>